{% extends "base.html" %}

{% block title %}Professional Dashboard - NeuralBrain-AI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary: #0d6efd;
        --success: #198754;
        --danger: #dc3545;
        --warning: #ffc107;
        --info: #0dcaf0;
        --dark: #212529;
        --light: #f8f9fa;
    }
    
    .dashboard-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding-top: 40px;
        padding-bottom: 60px;
    }
    
    .dashboard-header {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-header h1 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 800;
        font-size: 2.5rem;
        margin-bottom: 10px;
    }
    
    .dashboard-header p {
        font-size: 1.1rem;
        color: #666;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 5px solid;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
    }
    
    .stat-card.primary { border-left-color: var(--primary); }
    .stat-card.success { border-left-color: var(--success); }
    .stat-card.danger { border-left-color: var(--danger); }
    .stat-card.warning { border-left-color: var(--warning); }
    .stat-card.info { border-left-color: var(--info); }
    
    .stat-card-icon {
        font-size: 2.5rem;
        opacity: 0.15;
        float: right;
    }
    
    .stat-card-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 10px 0;
    }
    
    .stat-card-label {
        font-size: 0.95rem;
        color: #999;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chart-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .chart-card:hover {
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
    }
    
    .chart-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 25px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .chart-header h6 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .chart-header i {
        margin-right: 10px;
    }
    
    .chart-body {
        padding: 25px;
        min-height: 320px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chart-body canvas {
        max-height: 300px;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .metric-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #e9ecef;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }
    
    .metric-label {
        font-size: 0.85rem;
        color: #999;
        margin-top: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .section-title {
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 30px;
        padding-left: 20px;
        border-left: 4px solid white;
    }
    
    .action-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }
    
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        color: white;
        text-decoration: none;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .data-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }
    
    .data-table table {
        width: 100%;
        margin: 0;
    }
    
    .data-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .data-table th {
        padding: 15px 20px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }
    
    .data-table td {
        padding: 12px 20px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .data-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .badge-success {
        background: #d4edda;
        color: #155724;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .badge-danger {
        background: #f8d7da;
        color: #721c24;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .dashboard-header h1 {
            font-size: 1.8rem;
        }
        
        .chart-body {
            min-height: 250px;
        }
        
        .metrics-grid {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
    }
    
    .btn-gradient {
        background: linear-gradient(135deg, rgb(102, 126, 234) 0%, rgb(118, 75, 162) 100%);
        color: white;
        font-weight: 600;
        border: none;
    }
    
    .btn-gradient:hover {
        background: linear-gradient(135deg, rgb(118, 75, 162) 0%, rgb(102, 126, 234) 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

<!-- Dashboard Header -->
<div class="dashboard-header">
    <h1><i class="fas fa-heartbeat"></i> NeuralBrain Health Analytics</h1>
    <p class="text-muted">Professional Real-Time Health Monitoring Dashboard</p>
    <a href="{{ url_for('views.health_risk') }}" class="btn btn-lg mt-3 btn-gradient">
        <i class="fas fa-shield-alt"></i> AI Risk Assessment
    </a>
</div>

<div class="container-fluid">
    <!-- System Statistics Cards -->
    <div class="section-title">
        <i class="fas fa-chart-bar"></i> System Overview
    </div>
    
    <div class="row">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card primary">
                <i class="fas fa-database stat-card-icon"></i>
                <div class="stat-card-label">Total Records</div>
                <div class="stat-card-value text-primary">{{ stats.total_records or 0 }}</div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stat-card success">
                <i class="fas fa-check-circle stat-card-icon"></i>
                <div class="stat-card-label">Valid Records</div>
                <div class="stat-card-value text-success">{{ stats.valid_records or 0 }}</div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stat-card danger">
                <i class="fas fa-exclamation-circle stat-card-icon"></i>
                <div class="stat-card-label">Invalid Records</div>
                <div class="stat-card-value text-danger">{{ stats.invalid_records or 0 }}</div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stat-card info">
                <i class="fas fa-network-wired stat-card-icon"></i>
                <div class="stat-card-label">Data Sources</div>
                <div class="stat-card-value text-info">{{ stats.sources|length or 0 }}</div>
            </div>
        </div>
    </div>

    <!-- Health Metrics Summary -->
    <div class="section-title mt-5">
        <i class="fas fa-activity"></i> Health Metrics Summary
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-card">
                <div class="chart-header">
                    <h6><i class="fas fa-stats"></i> Real-Time Metrics Overview</h6>
                </div>
                <div class="chart-body">
                    <div class="metrics-grid" id="metricsGrid">
                        <div class="metric-item">
                            <div class="metric-value">--</div>
                            <div class="metric-label">Heart Rate</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">--</div>
                            <div class="metric-label">Temperature</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">--</div>
                            <div class="metric-label">O₂ Saturation</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">--</div>
                            <div class="metric-label">Glucose</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">--</div>
                            <div class="metric-label">Blood Pressure</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">--</div>
                            <div class="metric-label">Resp. Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="section-title mt-5">
        <i class="fas fa-chart-line"></i> Advanced Visualizations
    </div>


<div class="row mb-4">
    <!-- Heart Rate Chart -->
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h6><i class="fas fa-heartbeat text-danger"></i> Heart Rate Metrics</h6>
            </div>
            <div class="chart-body">
                <canvas id="heartRateChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Temperature Chart -->
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h6><i class="fas fa-thermometer-half text-warning"></i> Temperature Distribution</h6>
            </div>
            <div class="chart-body">
                <canvas id="temperatureChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Blood Pressure Chart -->
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h6><i class="fas fa-caret-up text-info"></i> Blood Pressure Reading</h6>
            </div>
            <div class="chart-body">
                <canvas id="bloodPressureChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Oxygen Saturation Chart -->
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h6><i class="fas fa-wind text-success"></i> Oxygen Saturation Level</h6>
            </div>
            <div class="chart-body">
                <canvas id="oxygenChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Glucose Level Chart -->
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h6><i class="fas fa-droplet text-danger"></i> Glucose Level</h6>
            </div>
            <div class="chart-body">
                <canvas id="glucoseChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Respiratory Rate Chart -->
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h6><i class="fas fa-lungs text-info"></i> Respiratory Rate</h6>
            </div>
            <div class="chart-body">
                <canvas id="respiratoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Sources Distribution -->
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h6><i class="fas fa-layer-group"></i> Data Distribution by Source</h6>
            </div>
            <div class="chart-body">
                <canvas id="dataSourceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Record Status Distribution -->
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h6><i class="fas fa-pie-chart"></i> Record Status Distribution</h6>
            </div>
            <div class="chart-body">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2: Blood Pressure & Oxygen -->
<div class="row mb-4">
    <!-- Blood Pressure Chart -->
    <div class="col-lg-6 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light py-3 border-0">
                <h6 class="mb-0">
                    <i class="fas fa-caret-up text-info"></i> Blood Pressure Reading
                </h6>
            </div>
            <div class="card-body">
                <canvas id="bloodPressureChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <!-- Oxygen Saturation Chart -->
    <div class="col-lg-6 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light py-3 border-0">
                <h6 class="mb-0">
                    <i class="fas fa-wind text-success"></i> Oxygen Saturation Level
                </h6>
            </div>
            <div class="card-body">
                <canvas id="oxygenChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 3: Additional Metrics -->
<div class="row mb-4">
    <!-- Glucose Level Chart -->
    <div class="col-lg-6 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light py-3 border-0">
                <h6 class="mb-0">
                    <i class="fas fa-droplet text-danger"></i> Glucose Level
                </h6>
            </div>
            <div class="card-body">
                <canvas id="glucoseChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <!-- Respiratory Rate Chart -->
    <div class="col-lg-6 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light py-3 border-0">
                <h6 class="mb-0">
                    <i class="fas fa-lungs text-info"></i> Respiratory Rate
                </h6>
            </div>
            <div class="card-body">
                <canvas id="respiratoryChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Sources Distribution -->
<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light py-3 border-0">
                <h6 class="mb-0">
                    <i class="fas fa-layer-group"></i> Data Distribution by Source
                </h6>
            </div>
            <div class="card-body">
                <canvas id="dataSourceChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <!-- Record Status Distribution -->
    <div class="col-lg-6 mb-3">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light py-3 border-0">
                <h6 class="mb-0">
                    <i class="fas fa-pie-chart"></i> Record Status Distribution
                </h6>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Ingestion Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light py-3 border-0">
                <h5 class="mb-0">
                    <i class="fas fa-download"></i> Data Ingestion Controls
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Manually trigger health data ingestion from all configured public APIs.
                </p>
                <form method="POST" action="{{ url_for('views.trigger_ingest') }}" class="d-inline">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-sync-alt"></i> Ingest Data Now
                    </button>
                </form>
                {% if stats.latest_ingestion %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <small class="text-muted">
                            <strong>Last Ingestion:</strong> 
                            {% if stats.latest_ingestion.timestamp %}
                                {{ stats.latest_ingestion.timestamp|replace('T', ' ')|truncate(19, True, '') }}
                            {% endif %}
                            from <strong>{{ stats.latest_ingestion.api_source }}</strong> 
                            - Status: 
                            <span class="badge {% if stats.latest_ingestion.status == 'success' %}bg-success{% elif stats.latest_ingestion.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                {{ stats.latest_ingestion.status|upper }}
                            </span>
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Active Data Sources -->
{% if stats.sources %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light py-3 border-0">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group"></i> Active Data Sources
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for source in stats.sources %}
                    <div class="col-md-6 mb-3">
                        <div class="p-3 border rounded">
                            <h6 class="fw-bold text-uppercase mb-2">{{ source }}</h6>
                            <a href="{{ url_for('views.data_explorer', source=source) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-search"></i> View Data
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle"></i> No data sources available yet. Click "Ingest Data Now" to fetch health data.
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// Parse metrics data from template
const metricsData = {{ metrics_json|safe }};

// Chart colors
const colors = {
    primary: '#0d6efd',
    success: '#198754',
    danger: '#dc3545',
    warning: '#ffc107',
    info: '#0dcaf0',
    light: '#f8f9fa',
    dark: '#212529'
};

// Helper function to create gauge chart options
function createGaugeOptions(title) {
    return {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0,0,0,0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#ddd',
                borderWidth: 1
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                max: 100,
                grid: {
                    color: 'rgba(0,0,0,0.05)'
                }
            }
        }
    };
}

// Heart Rate Chart
if (metricsData['heart_rate']) {
    const hr = metricsData['heart_rate'];
    new Chart(document.getElementById('heartRateChart'), {
        type: 'bar',
        data: {
            labels: ['Heart Rate (bpm)'],
            datasets: [
                {
                    label: 'Average',
                    data: [hr.average],
                    backgroundColor: colors.danger,
                    borderColor: colors.danger,
                    borderWidth: 1
                },
                {
                    label: 'Min',
                    data: [hr.min],
                    backgroundColor: colors.info,
                    borderColor: colors.info,
                    borderWidth: 1
                },
                {
                    label: 'Max',
                    data: [hr.max],
                    backgroundColor: colors.warning,
                    borderColor: colors.warning,
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 120,
                    ticks: {
                        stepSize: 20
                    }
                }
            }
        }
    });
}

// Temperature Chart
if (metricsData['temperature']) {
    const temp = metricsData['temperature'];
    new Chart(document.getElementById('temperatureChart'), {
        type: 'line',
        data: {
            labels: ['Min', 'Average', 'Max'],
            datasets: [{
                label: 'Temperature (°C)',
                data: [temp.min, temp.average, temp.max],
                borderColor: colors.warning,
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointBackgroundColor: colors.warning,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 36,
                    max: 39
                }
            }
        }
    });
}

// Blood Pressure Chart
if (metricsData['blood_pressure_sys'] && metricsData['blood_pressure_dia']) {
    const sys = metricsData['blood_pressure_sys'];
    const dia = metricsData['blood_pressure_dia'];
    new Chart(document.getElementById('bloodPressureChart'), {
        type: 'radar',
        data: {
            labels: ['Min', 'Average', 'Max'],
            datasets: [
                {
                    label: 'Systolic (mmHg)',
                    data: [sys.min, sys.average, sys.max],
                    borderColor: colors.danger,
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: colors.danger
                },
                {
                    label: 'Diastolic (mmHg)',
                    data: [dia.min, dia.average, dia.max],
                    borderColor: colors.info,
                    backgroundColor: 'rgba(13, 202, 240, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: colors.info
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 160
                }
            }
        }
    });
}

// Oxygen Saturation Chart
if (metricsData['oxygen_saturation']) {
    const o2 = metricsData['oxygen_saturation'];
    new Chart(document.getElementById('oxygenChart'), {
        type: 'doughnut',
        data: {
            labels: ['Oxygen Level', 'Remaining'],
            datasets: [{
                data: [o2.average, 100 - o2.average],
                backgroundColor: [colors.success, 'rgba(0,0,0,0.1)'],
                borderColor: ['#fff', '#fff'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            }
        }
    });
}

// Glucose Level Chart
if (metricsData['glucose_level']) {
    const glucose = metricsData['glucose_level'];
    new Chart(document.getElementById('glucoseChart'), {
        type: 'bar',
        data: {
            labels: ['Glucose Level (mg/dL)'],
            datasets: [
                {
                    label: 'Average',
                    data: [glucose.average],
                    backgroundColor: colors.danger,
                    borderColor: colors.danger,
                    borderWidth: 1
                },
                {
                    label: 'Min',
                    data: [glucose.min],
                    backgroundColor: colors.success,
                    borderColor: colors.success,
                    borderWidth: 1
                },
                {
                    label: 'Max',
                    data: [glucose.max],
                    backgroundColor: colors.warning,
                    borderColor: colors.warning,
                    borderWidth: 1
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    max: 150
                }
            }
        }
    });
}

// Respiratory Rate Chart
if (metricsData['respiratory_rate']) {
    const resp = metricsData['respiratory_rate'];
    new Chart(document.getElementById('respiratoryChart'), {
        type: 'line',
        data: {
            labels: ['Min', 'Average', 'Max'],
            datasets: [{
                label: 'Respiratory Rate (breaths/min)',
                data: [resp.min, resp.average, resp.max],
                borderColor: colors.info,
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointBackgroundColor: colors.info,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 30
                }
            }
        }
    });
}

// Data Source Distribution (Pie Chart)
fetch('/api/analytics')
    .then(response => response.json())
    .then(data => {
        if (data.statistics && data.statistics.sources) {
            const sources = data.statistics.sources;
            const sourceLabels = Object.keys(sources);
            const sourceData = Object.values(sources);
            const sourceColors = [colors.primary, colors.success, colors.danger, colors.warning, colors.info];
            
            new Chart(document.getElementById('dataSourceChart'), {
                type: 'pie',
                data: {
                    labels: sourceLabels,
                    datasets: [{
                        data: sourceData,
                        backgroundColor: sourceColors.slice(0, sourceLabels.length),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + ' records';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Status Distribution
        if (data.statistics) {
            const statusData = [
                data.statistics.valid_records,
                data.statistics.invalid_records
            ];
            
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Valid', 'Invalid'],
                    datasets: [{
                        data: statusData,
                        backgroundColor: [colors.success, colors.danger],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + ' records';
                                }
                            }
                        }
                    }
                }
            });
        }
    })
    .catch(error => console.error('Error loading analytics:', error));
</script>
{% endblock %}
