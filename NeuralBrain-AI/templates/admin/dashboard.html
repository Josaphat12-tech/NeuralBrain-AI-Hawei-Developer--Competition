{% extends "admin/base_dashboard.html" %}

{% block title %}Dashboard - NeuralBrain AI{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 0 0 1rem 1rem;
    }

    @media (max-width: 768px) {
        #map {
            height: 350px;
        }
    }

    @media (max-width: 640px) {
        #map {
            height: 300px;
        }
    }

    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 1.5rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .stat-card {
        position: relative;
        overflow: hidden;
    }

    .stat-icon {
        position: absolute;
        top: 0;
        right: 0;
        padding: 1rem;
        opacity: 0.1;
        width: 6rem;
        height: 6rem;
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
    }

    .stat-icon svg {
        width: 100%;
        height: 100%;
        stroke: currentColor;
        stroke-width: 1.5;
        fill: none;
    }

    .stat-val {
        font-size: clamp(1.5rem, 4vw, 2.25rem);
        font-weight: 700;
        margin: 0.5rem 0;
        line-height: 1.1;
    }

    .stat-label {
        font-size: clamp(0.7rem, 2vw, 0.875rem);
        color: var(--text-gray);
        text-transform: uppercase;
        font-weight: 700;
    }

    .badge {
        font-size: clamp(0.65rem, 1.5vw, 0.75rem);
    }

    @media (max-width: 640px) {
        .stat-val {
            margin: 0.25rem 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="responsive-header">
    <div>
        <h2 class="text-3xl">Global Dashboard</h2>
        <p class="text-gray" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; font-size: clamp(0.875rem, 2vw, 1rem);">
            <span
                style="width: 8px; height: 8px; background-color: var(--accent-green); border-radius: 50%; display: inline-block;"
                class="animate-pulse"></span>
            <span>Real-time health monitoring</span>
        </p>
    </div>
    <div class="header-actions" style="text-align: right; min-width: 200px;">
        <p class="text-xs" style="color: var(--text-muted); font-weight: 700; text-transform: uppercase;">Last Synced
        </p>
        <p class="text-sm" style="color: var(--accent-blue); font-family: monospace;">
            {{ stats.latest_ingestion.timestamp if stats.latest_ingestion else 'Just now' }}
        </p>
    </div>
</div>

<!-- Top Stats Grid -->
<div class="grid-4 mb-6">
    <!-- Total Records -->
    <div class="glass p-6 stat-card" data-stat="total_records">
        <div class="stat-icon" style="color: var(--accent-green);">
            <svg viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                <path d="M2 12h20" />
            </svg>
        </div>
        <h3 class="stat-label">Total Records</h3>
        <div style="display: flex; align-items: center;">
            <span class="stat-val" id="total-records-val">{{ stats.total_records }}</span>
            <span class="badge" id="total-records-trend"
                style="background: rgba(34, 197, 94, 0.1); color: var(--accent-green); margin-left: 0.5rem;">+12%</span>
        </div>
    </div>

    <!-- Valid Records -->
    <div class="glass p-6 stat-card" data-stat="valid_data">
        <div class="stat-icon" style="color: var(--accent-blue);">
            <svg viewBox="0 0 24 24">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
            </svg>
        </div>
        <h3 class="stat-label">Valid Data</h3>
        <div style="display: flex; align-items: center;">
            <span class="stat-val" id="valid-data-val">{{ stats.valid_records }}</span>
            <span class="badge" id="valid-data-quality"
                style="background: rgba(59, 130, 246, 0.1); color: var(--accent-blue); margin-left: 0.5rem;">High
                Quality</span>
        </div>
    </div>

    <!-- Alerts -->
    <div class="glass p-6 stat-card" data-stat="alerts">
        <div class="stat-icon" style="color: var(--accent-red);">
            <svg viewBox="0 0 24 24">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
            </svg>
        </div>
        <h3 class="stat-label">Active Alerts</h3>
        <div style="display: flex; align-items: center;">
            <span class="stat-val" id="active-alerts-val">0</span>
            <span class="badge" id="active-alerts-badge" style="margin-left: 0.5rem;">LOADING...</span>
        </div>
    </div>

    <!-- Data Quality -->
    <div class="glass p-6 stat-card" data-stat="quality">
        <div class="stat-icon" style="color: var(--accent-purple);">
            <svg viewBox="0 0 24 24">
                <line x1="18" y1="20" x2="18" y2="10" />
                <line x1="12" y1="20" x2="12" y2="4" />
                <line x1="6" y1="20" x2="6" y2="14" />
            </svg>
        </div>
        <h3 class="stat-label">Quality Score</h3>
        <div style="display: flex; align-items: center;">
            <span class="stat-val" id="quality-score-val">{{ "%.1f"|format(stats.data_quality) }}%</span>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
    <!-- Map Section -->
    <div class="glass">
        <div class="p-6"
            style="border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between;">
            <h3 class="font-bold" style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="width: 8px; height: 8px; background-color: var(--accent-red); border-radius: 50%;"
                    class="animate-pulse"></span>
                Live Outbreak Heatmap
            </h3>
            <button class="badge"
                style="background: transparent; cursor: pointer; color: var(--accent-blue); border: 1px solid var(--accent-blue);">Global
                View</button>
        </div>
        <div id="map" style="background-color: #0f172a;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Heat-Map Module -->
<script src="{{ url_for('static', filename='js/heatmap.js') }}"></script>

<style>
    /* Heat-Map Popup Styling -->
    .heat-map-popup .leaflet-popup-content-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        border: none;
    }

    .heat-map-popup .leaflet-popup-tip {
        background: white;
    }

    .heat-map-legend {
        background: white;
        border-radius: 8px;
    }

    /* Heat-Map Marker Animations */
    @keyframes pulse-marker {
        0%, 100% {
            opacity: 0.8;
        }
        50% {
            opacity: 1;
        }
    }

    .heat-map-marker.risk-critical {
        animation: pulse-marker 2s ease-in-out infinite;
    }

    .heat-map-marker.risk-high {
        animation: pulse-marker 3s ease-in-out infinite;
    }
</style>

<script>
    // ========== REAL DATA LOADING FOR DASHBOARD ==========
    
    async function loadRealDashboardStats() {
        try {
            const response = await fetch('/api/dashboard/metrics');
            if (!response.ok) throw new Error('Failed to fetch metrics');
            
            const data = await response.json();
            if (data.status === 'success') {
                const metrics = data.metrics;
                
                // Update Total Records with trend
                document.getElementById('total-records-val').textContent = 
                    metrics.total_records.value.toLocaleString();
                const trendPercent = metrics.total_records.trend > 0 ? '+' : '';
                document.getElementById('total-records-trend').textContent = 
                    `${trendPercent}${metrics.total_records.trend}%`;
                
                // Update Valid Data with quality
                document.getElementById('valid-data-val').textContent = 
                    metrics.valid_data.value.toLocaleString();
                document.getElementById('valid-data-quality').textContent = 
                    `${metrics.valid_data.quality}% Quality`;
                
                // Update Quality Score
                document.getElementById('quality-score-val').textContent = 
                    metrics.data_sources.last_ingestion ? 'Updated' : 'Calculating...';
                    
                console.log('✅ Dashboard stats updated with real data');
            }
        } catch (error) {
            console.error('❌ Error loading dashboard stats:', error);
        }
    }

    async function loadRealAlerts() {
        try {
            const response = await fetch('/api/alerts?active_only=true');
            if (!response.ok) throw new Error('Failed to fetch alerts');
            
            const data = await response.json();
            if (data.status === 'success') {
                const alertCount = data.total_alerts;
                
                // Update alert count
                document.getElementById('active-alerts-val').textContent = alertCount;
                
                // Update alert badge based on count
                const alertBadge = document.getElementById('active-alerts-badge');
                if (alertCount === 0) {
                    alertBadge.innerHTML = '<i class="fas fa-check-circle"></i> NONE';
                    alertBadge.style.background = 'rgba(34, 197, 94, 0.1)';
                    alertBadge.style.color = 'var(--accent-green)';
                    alertBadge.style.border = '1px solid rgba(34, 197, 94, 0.2)';
                } else if (alertCount < 3) {
                    alertBadge.innerHTML = '<i class="fas fa-exclamation"></i> LOW';
                    alertBadge.style.background = 'rgba(249, 115, 22, 0.1)';
                    alertBadge.style.color = '#fb923c';
                    alertBadge.style.border = '1px solid rgba(249, 115, 22, 0.2)';
                } else {
                    alertBadge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> CRITICAL';
                    alertBadge.style.background = 'rgba(239, 68, 68, 0.1)';
                    alertBadge.style.color = 'var(--accent-red)';
                    alertBadge.style.border = '1px solid rgba(239, 68, 68, 0.2)';
                    alertBadge.classList.add('animate-pulse');
                }
                
                console.log('✅ Real alerts count:', alertCount);
            }
        } catch (error) {
            console.error('❌ Error loading alerts:', error);
        }
    }

    // Initialize Dashboard Heat-Map with Faster Updates
    document.addEventListener('DOMContentLoaded', async () => {
        // Load real data first
        await loadRealDashboardStats();
        await loadRealAlerts();

        const dashboardHeatMap = new NeuralBrainHeatMap('map', {
            updateInterval: 15000,  // Update every 15 seconds for dashboard
            zoomLevel: 2,
            center: [20, 0]
        });

        await dashboardHeatMap.initialize();

        // Store reference
        window.dashboardHeatMap = dashboardHeatMap;

        // Refresh stats every 30 seconds
        setInterval(() => {
            loadRealDashboardStats();
            loadRealAlerts();
        }, 30000);

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.dashboardHeatMap) {
                window.dashboardHeatMap.resize();
            }
        });

        // Listen for heat-map updates
        document.addEventListener('heatmap-updated', (event) => {
            const countries = event.detail.countries;
            console.log(`Dashboard: Heat-map synchronized with ${countries.length} countries`);
            
            // Optional: Update any dashboard summary metrics
            if (window.dashboardStats) {
                window.dashboardStats.lastUpdate = event.detail.timestamp;
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.dashboardHeatMap) {
                window.dashboardHeatMap.destroy();
            }
        });
    });
</script>
{% endblock %}