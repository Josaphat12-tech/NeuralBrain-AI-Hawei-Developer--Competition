{% extends "base.html" %}

{% block title %}Data Explorer - NeuralBrain-AI{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #6366f1;
        --secondary: #8b5cf6;
        --accent: #ec4899;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --card-bg: rgba(15, 23, 42, 0.8);
        --border-color: rgba(100, 116, 139, 0.3);
    }

    /* ==================== PAGE HEADER ==================== */
    .data-explorer-hero {
        padding: 2.5rem 2rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
        border-radius: 16px;
        border: 1px solid var(--border-color);
        margin-bottom: 2rem;
        animation: fadeInUp 0.6s ease-out;
    }

    .data-explorer-hero h1 {
        font-size: 2.2rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .data-explorer-hero p {
        color: #cbd5e1;
        font-size: 1rem;
        margin: 0;
    }

    /* ==================== FILTERS SECTION ==================== */
    .filter-section {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
    }

    .filter-section h6 {
        font-size: 1rem;
        font-weight: 700;
        color: #f1f5f9;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-section i {
        color: var(--primary);
        font-size: 1.1rem;
    }

    .filter-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-group label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #cbd5e1;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-group select,
    .filter-group input {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--border-color);
        color: #f1f5f9;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        transition: all 0.3s ease;
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .btn-apply {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-apply:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        color: white;
        text-decoration: none;
    }

    /* ==================== DATA CARDS SECTION ==================== */
    .data-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .data-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        animation: fadeInUp 0.6s ease-out;
    }

    .data-card:hover {
        border-color: var(--primary);
        transform: translateY(-6px);
        box-shadow: 0 20px 50px rgba(99, 102, 241, 0.2);
    }

    .data-card-header {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
        padding: 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .data-card-header-left h3 {
        font-size: 1rem;
        font-weight: 700;
        color: #f1f5f9;
        margin-bottom: 0.5rem;
    }

    .data-card-header-left p {
        font-size: 0.85rem;
        color: #94a3b8;
        margin: 0;
    }

    .data-card-badges {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        text-align: right;
    }

    .badge-custom {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-valid {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .badge-invalid {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .badge-pending {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }

    .data-card-body {
        padding: 1.25rem;
    }

    .json-viewer {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        color: #cbd5e1;
        max-height: 300px;
        overflow-y: auto;
        line-height: 1.6;
    }

    .json-key {
        color: #ec4899;
        font-weight: 600;
    }

    .json-value {
        color: #10b981;
    }

    .json-string {
        color: #fbbf24;
    }

    .json-number {
        color: #60a5fa;
    }

    .data-card-footer {
        padding: 1rem 1.25rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 0.75rem;
        justify-content: space-between;
    }

    .btn-view {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
        flex: 1;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .btn-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        color: white;
        text-decoration: none;
    }

    /* ==================== PAGINATION ==================== */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .pagination-info {
        font-size: 0.9rem;
        color: #cbd5e1;
        margin-right: 1rem;
    }

    .pagination-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .page-btn {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: #cbd5e1;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-width: 40px;
    }

    .page-btn:hover:not(.disabled):not(.active) {
        background: rgba(99, 102, 241, 0.2);
        border-color: var(--primary);
        color: var(--primary);
        transform: translateY(-2px);
    }

    .page-btn.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-color: var(--primary);
        color: white;
    }

    .page-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ==================== MODAL STYLES ==================== */
    .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
    }

    .modal-header {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h5 {
        color: #f1f5f9;
    }

    .modal-body {
        color: #e2e8f0;
    }

    .modal-body dt {
        color: var(--primary);
        font-weight: 700;
    }

    .modal-body dd {
        color: #cbd5e1;
    }

    .modal-body pre {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        color: #cbd5e1;
        border-radius: 8px;
    }

    /* ==================== ANIMATIONS ==================== */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ==================== RESPONSIVE ==================== */
    @media (max-width: 768px) {
        .data-explorer-hero h1 {
            font-size: 1.8rem;
        }

        .filter-controls {
            grid-template-columns: 1fr;
        }

        .data-cards-container {
            grid-template-columns: 1fr;
        }

        .pagination-container {
            flex-direction: column;
            gap: 1rem;
        }

        .pagination-info {
            margin-right: 0;
        }
    }

    @media (max-width: 576px) {
        .data-explorer-hero {
            padding: 1.5rem 1rem;
        }

        .data-explorer-hero h1 {
            font-size: 1.5rem;
        }

        .filter-section {
            padding: 1.5rem 1rem;
        }

        .data-card {
            border-radius: 10px;
        }

        .data-card-header {
            padding: 1rem;
        }

        .data-card-body {
            padding: 1rem;
        }

        .json-viewer {
            font-size: 0.75rem;
            max-height: 250px;
        }

        .page-btn {
            padding: 0.5rem 0.8rem;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 400px) {
        .data-explorer-hero h1 {
            font-size: 1.3rem;
        }

        .data-card-header {
            flex-direction: column;
            gap: 0.75rem;
        }

        .data-card-badges {
            text-align: left;
        }

        .page-btn {
            padding: 0.5rem 0.6rem;
            font-size: 0.75rem;
            min-width: 36px;
        }

        .pagination-buttons {
            gap: 0.3rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Data Explorer Header -->
<div class="data-explorer-hero">
    <h1><i class="fas fa-database"></i> Data Explorer</h1>
    <p>Browse, filter, and analyze health data records with professional JSON visualization</p>
</div>

<!-- Filter Controls -->
<div class="filter-section">
    <h6><i class="fas fa-filter"></i> Advanced Filters</h6>
    <form method="GET" class="filter-controls">
        <div class="filter-group">
            <label for="source">Data Source</label>
            <select name="source" id="source">
                <option value="">All Sources</option>
                {% for src in sources %}
                <option value="{{ src }}" {% if current_source == src %}selected{% endif %}>{{ src }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label for="status">Status</label>
            <select name="status" id="status">
                <option value="">All Statuses</option>
                <option value="valid" {% if current_status == 'valid' %}selected{% endif %}>✓ Valid</option>
                <option value="invalid" {% if current_status == 'invalid' %}selected{% endif %}>✗ Invalid</option>
                <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>⏳ Pending</option>
            </select>
        </div>
        
        <button type="submit" class="btn-apply">
            <i class="fas fa-search"></i> Apply Filters
        </button>
    </form>
</div>

<!-- Data Cards -->
{% if records and paginated %}
<div class="data-cards-container">
    {% for record in records %}
    <div class="data-card">
        <!-- Card Header -->
        <div class="data-card-header">
            <div class="data-card-header-left">
                <h3>Record #{{ record.id }}</h3>
                <p>{{ record.timestamp|replace('T', ' ')|truncate(19, True, '') }}</p>
            </div>
            <div class="data-card-badges">
                <span class="badge-custom badge-{{ record.status }}">
                    {% if record.status == 'valid' %}✓ Valid{% elif record.status == 'invalid' %}✗ Invalid{% else %}⏳ Pending{% endif %}
                </span>
                <span class="badge-custom" style="background: rgba(139, 92, 246, 0.2); color: var(--secondary);">
                    {{ record.data_source }}
                </span>
            </div>
        </div>

        <!-- Card Body with JSON -->
        <div class="data-card-body">
            <div class="json-viewer">
                <div><span class="json-key">"id"</span>: <span class="json-number">{{ record.id }}</span>,</div>
                <div><span class="json-key">"source"</span>: <span class="json-string">"{{ record.data_source }}"</span>,</div>
                <div><span class="json-key">"status"</span>: <span class="json-string">"{{ record.status }}"</span>,</div>
                <div><span class="json-key">"timestamp"</span>: <span class="json-string">"{{ record.timestamp }}"</span>,</div>
                {% if record.processed_data %}
                    <div><span class="json-key">"data"</span>: {</div>
                    {% for key, value in record.processed_data.items()|list|slice(3) %}
                        <div style="margin-left: 1.5rem;"><span class="json-key">"{{ key }}"</span>: 
                        {% if value is number %}<span class="json-number">{{ value }}</span>{% else %}<span class="json-string">"{{ value }}"</span>{% endif %},
                        </div>
                    {% endfor %}
                    <div>  }</div>
                {% endif %}
            </div>
        </div>

        <!-- Card Footer -->
        <div class="data-card-footer">
            <a href="#recordModal{{ record.id }}" class="btn-view" data-bs-toggle="modal" data-bs-target="#recordModal{{ record.id }}">
                <i class="fas fa-expand"></i> View Full
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Inline Professional Pagination -->
<div class="pagination-container">
    <span class="pagination-info">
        <i class="fas fa-info-circle"></i>
        Page <strong>{{ paginated.page }}</strong> of <strong>{{ paginated.pages }}</strong> 
        (<strong>{{ paginated.total }}</strong> records)
    </span>
    
    <div class="pagination-buttons">
        {% if paginated.has_prev %}
            <a href="{{ url_for('views.data_explorer', page=1, source=current_source, status=current_status) }}" class="page-btn">
                <i class="fas fa-chevron-left"></i> First
            </a>
            <a href="{{ url_for('views.data_explorer', page=paginated.prev_num, source=current_source, status=current_status) }}" class="page-btn">
                <i class="fas fa-chevron-left"></i> Prev
            </a>
        {% else %}
            <span class="page-btn disabled"><i class="fas fa-chevron-left"></i> First</span>
            <span class="page-btn disabled"><i class="fas fa-chevron-left"></i> Prev</span>
        {% endif %}

        {% for page_num in paginated.iter_pages(left_edge=1, right_edge=1) %}
            {% if page_num %}
                {% if page_num == paginated.page %}
                    <span class="page-btn active">{{ page_num }}</span>
                {% else %}
                    <a href="{{ url_for('views.data_explorer', page=page_num, source=current_source, status=current_status) }}" class="page-btn">{{ page_num }}</a>
                {% endif %}
            {% else %}
                <span class="page-btn disabled">...</span>
            {% endif %}
        {% endfor %}

        {% if paginated.has_next %}
            <a href="{{ url_for('views.data_explorer', page=paginated.next_num, source=current_source, status=current_status) }}" class="page-btn">
                Next <i class="fas fa-chevron-right"></i>
            </a>
            <a href="{{ url_for('views.data_explorer', page=paginated.pages, source=current_source, status=current_status) }}" class="page-btn">
                Last <i class="fas fa-chevron-right"></i>
            </a>
        {% else %}
            <span class="page-btn disabled">Next <i class="fas fa-chevron-right"></i></span>
            <span class="page-btn disabled">Last <i class="fas fa-chevron-right"></i></span>
        {% endif %}
    </div>
</div>

<!-- Record Detail Modals -->
{% for record in records %}
<div class="modal fade" id="recordModal{{ record.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-database"></i> Record #{{ record.id }} - {{ record.data_source }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4"><i class="fas fa-hashtag"></i> ID</dt>
                    <dd class="col-sm-8"><code>{{ record.id }}</code></dd>

                    <dt class="col-sm-4"><i class="fas fa-database"></i> Source</dt>
                    <dd class="col-sm-8"><span class="badge-custom" style="background: rgba(139, 92, 246, 0.2); color: var(--secondary);">{{ record.data_source }}</span></dd>

                    <dt class="col-sm-4"><i class="fas fa-check-circle"></i> Status</dt>
                    <dd class="col-sm-8">
                        <span class="badge-custom badge-{{ record.status }}">
                            {% if record.status == 'valid' %}✓ Valid{% elif record.status == 'invalid' %}✗ Invalid{% else %}⏳ Pending{% endif %}
                        </span>
                    </dd>

                    <dt class="col-sm-4"><i class="fas fa-calendar"></i> Timestamp</dt>
                    <dd class="col-sm-8"><small>{{ record.timestamp }}</small></dd>

                    <dt class="col-sm-4"><i class="fas fa-sync"></i> Updated</dt>
                    <dd class="col-sm-8"><small>{{ record.last_updated }}</small></dd>
                </dl>

                {% if record.processed_data %}
                <div class="mt-4">
                    <h6 class="fw-bold mb-2"><i class="fas fa-code"></i> Full Data</h6>
                    <pre class="json-viewer"><code>{{ record.processed_data|tojson(indent=2) }}</code></pre>
                </div>
                {% endif %}

                {% if record.validation_notes %}
                <div class="mt-3" style="background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; padding: 1rem; border-radius: 6px;">
                    <strong><i class="fas fa-exclamation"></i> Notes:</strong> {{ record.validation_notes }}
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-view" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% else %}
<div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 2rem; text-align: center;">
    <i class="fas fa-info-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 1rem; display: block;"></i>
    <p style="color: #cbd5e1; margin-bottom: 1rem;">No records found. Try adjusting your filters or ingest new data.</p>
    <a href="{{ url_for('views.trigger_ingest') }}" style="color: var(--success); font-weight: 600; text-decoration: none;">
        <i class="fas fa-upload"></i> Ingest Data Now
    </a>
</div>
{% endif %}

{% endblock %}
