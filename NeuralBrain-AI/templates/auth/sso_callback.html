<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syncing Session - NeuralBrain AI</title>
    <!-- Clerk JS SDK -->
    <script crossorigin="anonymous" data-clerk-publishable-key="pk_test_cmVhZHktbWFncGllLTg3LmNsZXJrLmFjY291bnRzLmRldiQ"
        src="https://ready-magpie-87.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left-color: #06b6d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div style="text-align: center;">
        <div class="loader" style="margin: 0 auto 1.5rem;"></div>
        <p>Synchronizing your secure session...</p>
    </div>

    <script>
        async function handleSSO() {
            try {
                // Wait for Clerk to load
                let attempts = 0;
                while (typeof window.Clerk === 'undefined' && attempts < 50) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                }

                if (window.Clerk) {
                    await window.Clerk.load();

                    try {
                        // Explicitly handle the redirect callback
                        await window.Clerk.handleRedirectCallback();
                        console.log("Redirect callback handled successfully");
                    } catch (e) {
                        console.log("Redirect callback not needed or already handled", e);
                    }

                    // Clerk will automatically handle the sso-callback if it's on this URL
                    // After success, we want to ensure the session cookie is set and redirect to dashboard
                    if (window.Clerk.session) {
                        const token = await window.Clerk.session.getToken();
                        document.cookie = `__session=${token}; path=/; max-age=3600; secure; samesite=strict`;

                        // NEW: Capture and sync user details from frontend to database
                        try {
                            // Poll for user details (sometimes it takes a moment after session is ready)
                            let user = window.Clerk.user;
                            let retries = 0;
                            while ((!user || !user.primaryEmailAddress) && retries < 10) {
                                console.log("Waiting for user details...");
                                await new Promise(r => setTimeout(r, 300));
                                user = window.Clerk.user;
                                retries++;
                            }

                            if (user) {
                                console.log("Capturing user details for sync...");
                                const syncData = {
                                    email: user.primaryEmailAddress ? user.primaryEmailAddress.emailAddress : '',
                                    first_name: user.firstName,
                                    last_name: user.lastName
                                };

                                await fetch('/auth/sync', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        // The backend uses the __session cookie, so we don't need a Bearer header here
                                        // unless we want to be extra safe.
                                    },
                                    body: JSON.stringify(syncData)
                                });
                                console.log("Profile sync request sent");
                            }
                        } catch (syncErr) {
                            console.error("Profile sync failed:", syncErr);
                            // Don't block redirect if sync fails
                        }

                        // Show success message before redirecting
                        document.querySelector('p').textContent = "Session verified! Redirecting...";

                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 500);
                    } else {
                        // If no session yet, Clerk might still be processing. 
                        console.log("Waiting for Clerk to complete SSO flow...");

                        // Fallback check
                        setTimeout(async () => {
                            if (window.Clerk.session) {
                                const token = await window.Clerk.session.getToken();
                                document.cookie = `__session=${token}; path=/; max-age=3600; secure; samesite=strict`;
                                window.location.href = '/dashboard';
                            } else {
                                // Only redirect to login if we truly failed after a delay
                                console.warn("Session still not found after delay");
                                // Optional: window.location.href = '/login?error=session_timeout';
                            }
                        }, 2000);
                    }
                }
            } catch (err) {
                console.error("SSO Callback Error:", err);
                document.querySelector('p').textContent = "Authentication failed. Redirecting...";
                setTimeout(() => {
                    window.location.href = '/login?error=sso_failed';
                }, 1500);
            }
        }
        handleSSO();
    </script>
</body>

</html>